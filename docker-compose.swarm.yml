# Docker Swarm Production Configuration
# Compliant with swarm.md Network Isolation Protocol
#
# Deployment:
#   1. Copy to /var/data/config/docker-compose-tallmanchat.yaml on Swarm Master
#   2. Run: make deploy STACK=tallmanchat
#
# Networks:
#   - tallmanchat_traefik: External Traefik routing (attached to infra_traefik)
#   - tallmanchat_internal: Inter-container communication (isolated)

networks:
  # External network for Traefik communication
  tallmanchat_traefik:
    driver: overlay
    attachable: true
  # Internal network for app components (isolated from ingress)
  tallmanchat_internal:
    driver: overlay
    attachable: true
  # Connect to the main Traefik ingress network
  traefik:
    external: true
    name: infra_traefik

services:
  # Main Application Service
  tallman-chat:
    image: ${REGISTRY:-}tallman-chat:${TAG:-latest}
    networks:
      - tallmanchat_traefik
      - tallmanchat_internal
      - traefik
    environment:
      - NODE_ENV=production
      - BACKEND_SERVICE_HOST=0.0.0.0
      - BACKEND_SERVICE_PORT=3231
      - UI_PORT=3230
      - PORT=3231
      # Secrets should be passed via Docker secrets or environment
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - LDAP_SERVICE_HOST=${LDAP_SERVICE_HOST:-host.docker.internal}
      - LDAP_SERVICE_PORT=${LDAP_SERVICE_PORT:-3100}
    volumes:
      # Persistent logs on NFS shared storage
      - /var/data/tallmanchat/logs:/app/logs
      # Knowledge base persistence (if using file-based storage)
      - /var/data/tallmanchat/data:/app/data
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 30s
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 120s
      resources:
        limits:
          cpus: '2.0'
          memory: 2048M
        reservations:
          cpus: '0.5'
          memory: 512M
      labels:
        # Traefik Configuration Labels
        - "traefik.enable=true"
        # UI Router (Frontend)
        - "traefik.http.routers.tallmanchat-ui.rule=Host(`tallmanchat.swarm.tallmanequipment.com`)"
        - "traefik.http.routers.tallmanchat-ui.entrypoints=https"
        - "traefik.http.routers.tallmanchat-ui.tls.certresolver=letsencrypt"
        - "traefik.http.routers.tallmanchat-ui.service=tallmanchat-ui"
        - "traefik.http.services.tallmanchat-ui.loadbalancer.server.port=3230"
        # API Router (Backend)
        - "traefik.http.routers.tallmanchat-api.rule=Host(`tallmanchat.swarm.tallmanequipment.com`) && PathPrefix(`/api`)"
        - "traefik.http.routers.tallmanchat-api.entrypoints=https"
        - "traefik.http.routers.tallmanchat-api.tls.certresolver=letsencrypt"
        - "traefik.http.routers.tallmanchat-api.service=tallmanchat-api"
        - "traefik.http.services.tallmanchat-api.loadbalancer.server.port=3231"
        # Network specification for Traefik
        - "traefik.docker.network=infra_traefik"
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:3231/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
