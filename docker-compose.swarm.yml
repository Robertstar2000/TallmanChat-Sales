version: '3.8'

services:
  app:
    image: 10.10.20.64:5000/tallman-chat:latest
    networks:
      - traefik
      - internal
    volumes:
      # Skill Compliance: Centralized NFS Storage mount
      - /var/data/tallman-chat:/app/data
    environment:
      - NODE_ENV=production
      - PORT=3231
      - UI_PORT=3230
      - DATA_DIR=/app/data
      # Skill Compliance: Identity Governance Override
      - BACKDOOR_USERNAME=robertstar@aol.com
      - BACKDOOR_PASSWORD=${BACKDOOR_PASSWORD:-admin} 
      # Skill Compliance: API Configuration (Swarm)
      # In Swarm, we use the domain name handled by Traefik
      - VITE_API_BASE_URL=https://learn.tallmanequipment.com
    deploy:
      mode: replicated
      replicas: 2
      placement:
        constraints:
          - node.role == worker
      labels:
        - "traefik.enable=true"
        # Router for the application (Frontend + Backend proxy)
        - "traefik.http.routers.tallman.rule=Host(`learn.tallmanequipment.com`)"
        - "traefik.http.routers.tallman.entrypoints=websecure"
        - "traefik.http.routers.tallman.tls.certresolver=myresolver"
        - "traefik.http.services.tallman.loadbalancer.server.port=3230"
        # Middleware for API routing if needed, but app handles /api internally via proxy or direct
        # Since VITE_API_BASE_URL is set, frontend might call API directly. 
        # But if frontend is served by Node server (production-server.js), it handles /api proxying too.
        # So routing to port 3230 (UI/Server) is sufficient.

networks:
  traefik:
    external: true
  internal:
    driver: overlay
    internal: true
